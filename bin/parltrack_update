#!/bin/bash
set -ex

OPENSHIFT_DATA_DIR="${OPENSHIFT_DATA_DIR-./}"

[ -d "$OPENSHIFT_DATA_DIR" ] || mkdir -p $OPENSHIFT_DATA_DIR

if [ -n "${OPENSHIFT_HOMEDIR-}" ]; then
    source ${OPENSHIFT_HOMEDIR}app-root/runtime/dependencies/python/virtenv/bin/activate
fi

function pipe_download_to_command() {
    cd $OPENSHIFT_DATA_DIR

    [ -n "${CLEAN-}" ] && rm -rf $1
    [ -f "$1" ] || wget http://parltrack.euwiki.org/dumps/$1 || exit 1

    if [ -n "${OPENSHIFT_REPO_DIR-}" ]; then
        cd $OPENSHIFT_REPO_DIR
    fi

    export DJANGO_SETTINGS_MODULE=toutatis.settings
    unxz -c ${OPENSHIFT_DATA_DIR}$1 | $2
    [ -n "${CLEAN-}" ] && rm -rf $1
}

if [ "$1" = "representatives" ]; then
    pipe_download_to_command ep_meps_current.json.xz parltrack_import_representatives
elif [ "$1" = "dossiers" ]; then
    pipe_download_to_command ep_dossiers.json.xz parltrack_import_dossiers
elif [ "$1" = "votes" ]; then
    pipe_download_to_command ep_votes.json.xz parltrack_import_votes
fi
